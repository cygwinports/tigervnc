inherit java

xserver_pvr=1.12.0-2

DESCRIPTION="X11 VNC client and servers"
HOMEPAGE="http://www.tigervnc.com/"
SRC_URI="mirror://sourceforge/tigervnc/${P}.tar.gz
         http://cgit.freedesktop.org/~jturney/xserver/snapshot/xserver-cygwin-${xserver_pvr}.tar.bz2"

PATCH_URI="
	fedora/tigervnc-102434.patch
	fedora/tigervnc-cookie.patch
	fedora/tigervnc-viewer-reparent.patch
	fedora/tigervnc11-rh692048.patch
	fedora/tigervnc11-xorg111.patch
	1.0.0-tx-select.patch
	1.1.0-hw-vnc-build.patch
	1.1.0-xorg112.patch
"

PKG_NAMES="${PN} ${PN}-server"
PKG_HINTS="setup server"
tigervnc_CONTENTS="etc/ usr/bin/vncviewer.exe usr/share/applications/ usr/share/doc/
                   usr/share/icons/ usr/share/locale/ usr/share/man/man1/vncviewer.*"
tigervnc_server_CONTENTS="--exclude=vncviewer.* usr/bin/ usr/lib/xorg/
                          usr/share/man/ usr/share/vnc/"

DIFF_EXCLUDES="Makefile.in aclocal.m4 configure fb.h fbrop.h pixman.h"

CYGPORT_USE_UNSTABLE_API=1
src_unpack_hook() {
	cd unix
	rm -fr xserver-tmp
	mv xserver xserver-tmp
	mv ../../xserver-cygwin-${xserver_pvr} xserver
	mv xserver-tmp/hw/vnc xserver/hw/
	rm -fr xserver-tmp/
	cygpatch xserver110.patch
}

src_compile() {
	cd ${S}
	cygautoreconf

	cd ${S}/unix/xserver
	cygautoreconf

	cd ${B}
	cygconf --with-system-jpeg
	cygmake

	mkdir -p ${B}/java
	lndirs ${S}/java ${B}/java
	cd ${B}/java/src
	cygjavac -classpath . $(find com/ -name '*.java')
	cygjar -cf VncViewer.jar -m com/tigervnc/vncviewer/MANIFEST.MF $(find com/tigervnc -name '*.class')

	mkdir -p ${B}/media
	lndirs ${S}/media ${B}/media
	cd ${B}/media
	check_prog_req rsvg-convert rsvg
	for i in 16 22 24 32 48 64
	do
		rsvg-convert -f png -w $i -h $i -o icons/tigervnc_$i.png tigervnc.svg
	done

	mkdir -p ${B}/unix/xserver
	cd ${B}/unix/xserver

	CYGCONF_SOURCE=${S}/unix/xserver
	cygconf \
		--disable-docs --disable-devel-docs \
		--disable-dmx \
		--disable-kdrive \
		--disable-xephyr \
		--disable-xfake \
		--disable-xfbdev \
		--disable-xnest \
		--disable-xorg \
		--disable-xquartz \
		--disable-xsdl \
		--disable-xvfb \
		--disable-xwin \
		--disable-composite \
		--disable-config-hal \
		--disable-config-udev \
		--disable-dri \
		--disable-dri2 \
		--disable-install-setuid \
		--disable-windowswm \
		--disable-xf86vidmode \
		--disable-xinerama \
		--disable-xv \
		--disable-xvmc \
		--disable-glx-tls \
		--disable-unit-tests \
		--with-sha1=libgcrypt \
		--with-log-dir=/var/log/xwin \
		--with-serverconfig-path=/usr/lib/X11 \
		--with-xkb-output=/var/lib/xkb \
		"--with-builder-addr=cygwin-ports-general@lists.sourceforge.net" \
		"--with-builderstring=Build Date: $(date +%Y-%m-%d)" \
		"--with-os-name=Cygwin" \
		"--with-os-vendor=Red Hat" \
		"--with-vendor-name=The Cygwin Ports project" \
		"--with-vendor-name-short=Cygwin Ports" \
		"--with-vendor-web=http://www.cygwinports.org/"

	cygmake
}

src_install() {
	cd ${B}
	cyginstall

	cd ${B}/java/src
	insinto /usr/share/vnc/classes
	doins VncViewer.jar com/tigervnc/vncviewer/index.vnc
#	pushd ${D}/usr/share/vnc/classes
#	${JAR} -xf VncViewer.jar
#	rm -fr META-INF
#	popd

	cd ${B}/media/icons
	for i in 16 22 24 32 48 64
	do
		insinto /usr/share/icons/hicolor/${i}x${i}/apps
		newins tigervnc_$i.png tigervnc.png
	done
	insinto /usr/share/icons/hicolor/scalable/apps
	doins tigervnc.svg

	make_desktop_entry vncviewer "TigerVNC Viewer" tigervnc "Network;RemoteAccess"

	cd ${B}/unix/xserver/
	cyginstall

	# conflicts with xorg-server-common
	rm -f ${D}/usr/lib/X11/protocol.txt ${D}/usr/share/man/man1/Xserver.* ${D}/var/lib/xkb/README.compiled
}
DOCS="LICENCE.TXT README.txt"

KEEP_LA_FILES="none"
